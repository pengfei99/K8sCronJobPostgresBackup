apiVersion: batch/v1
kind: Job
metadata:
  name: auto-restore-db
  labels:
    app: db-backup-restore
spec:
  template:
    spec:
      containers:
        - name: restore_bot
          image: liupengfei99/db_backup_restore:main
          env:
            - name: DB_LOGIN
              value: "user-pengfei"
            - name: DB_PWD
              value: "changeMe"
            - name: DB_HOST
              value: "postgresql-124499"
            - name: DB_PORT
              value: "5432"
            - name: BACKUP_DIR
              value: "s3://pengfei/tmp/sql_backup"
            - name: TARGET_DB
              value: "test"

          command: [ "python", "src/main.py", "--action", "auto_restore",
                     "--db_login", "$DB_LOGIN", "--db_pwd", "$DB_PWD", "--db_host", "$DB_HOST", "--db_port", "$DB_PORT",
                     "--backup_dir", "$BACKUP_DIR", "--target_db", "$TARGET_DB" ]
      restartPolicy: Never
  # A job's spec are immutable, we can't change them after job creation. We need to delete old job, and submit new job.
  # completions default value is 1, it means if 1 pod complete and return 0. The job is considered finished succesfully.
  completions: 1
  # parallelism default value is 1, it means 1 pod can run in parallel.
  parallelism: 1
  # set a dead line to retry the job.
  activeDeadlineSeconds: 100
  # auto remove the job after the job finished
  ttlSecondsAfterFinished: 150
  backoffLimit: 4